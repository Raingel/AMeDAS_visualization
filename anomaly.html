<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>氣象異常地圖</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css" />
    <style>
        #map {
            height: 500px;
            width: 100%;
        }

        #loading_text {
            display: none;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }

        #date_selector {
            margin-top: 10px;
            z-index: 1000;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div id="loading_text">Loading...</div>

<div id="map"></div>

<div id="date_selector">
    <div id="slider"></div>
    <select id="factor" onchange="load_data()" style="margin: 10px;">
        <option value="平均溫距平">平均溫距平</option>
        <option value="平均溼度距平">平均溼度距平</option>
        <option value="日均降水量距平">日均降水量距平</option>
    </select>
    <div id="step_value_single"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>

<script>
    // 初始化地圖
    const map = L.map('map', {
        center: [23, 120.5432229],
        zoom: 7
    });

    const TILE_SERVER_1 = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
    L.tileLayer(TILE_SERVER_1, {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let circles = [];
    let filename;

    // 顯示/隱藏 Loading 資訊
    function loading_info(bl) {
        const loading_text = document.getElementById("loading_text");
        loading_text.style.display = bl ? "block" : "none";
    }

    // 日期與檔案格式轉換
    function minus_Month(shift, type) {
        const date = new Date();
        let y = date.getFullYear();
        let m = date.getMonth() + 1 + parseInt(shift);
        while (m < 1) {
            m += 12;
            y -= 1;
        }
        if (type === "title") return y + "-" + (m < 10 ? '0' + m : m);
        if (type === "filename") return y + "_" + (m < 10 ? '0' + m : m) + ".json";
    }

    // 圓圈繪製
    function draw_circle(lat, lon, radius, color, opacity, weight, fill_color, fill_opacity) {
        return L.circle([lat, lon], {
            color: color,
            fillColor: fill_color,
            fillOpacity: fill_opacity,
            radius: radius,
            weight: weight,
            opacity: opacity
        }).addTo(map);
    }

    // 定義異常範圍和顏色
    const f_i = {
        "平均溫距平": {
            "scale": [-3, -1, -0.5, 0.5, 1, 3],
            "color": ["#382870", "#455fd5", "#34a9f8", "#b2f835", "yellow", "orange"]
        },
        "平均溼度距平": {
            "scale": [-20, -10, -3, 3, 10, 20],
            "color": ["#382870", "#455fd5", "#34a9f8", "#b2f835", "yellow", "orange"]
        },
        "日均降水量距平": {
            "scale": [-20, -10, -5, 5, 10, 20],
            "color": ["#382870", "#455fd5", "#34a9f8", "#b2f835", "yellow", "orange"]
        }
    };

    // 載入資料
    function load_data() {
        const factor = document.getElementById("factor").value;
        loading_info(true);
        $.ajax({
            url: "./anomaly/" + filename,
            dataType: "json",
            success: function (data) {
                if (circles.length > 0) {
                    circles.forEach(circle => map.removeLayer(circle));
                    circles = [];
                }

                data.forEach(point => {
                    const lat = point['緯度'];
                    const lon = point['經度'];
                    const stn_name = point['站名'];
                    const value = Math.round(point[factor] * 100) / 100;
                    if (value === -99.8) return;

                    const radius = 2500;
                    const color = f_i[factor]["color"].find((_, i) => value <= f_i[factor]["scale"][i]) || 'red';

                    const circle = draw_circle(lat, lon, radius, color, 0.7, 1, color, 0.7);
                    circle.bindPopup(`${stn_name}<br>Lat: ${lat}, Lon: ${lon}<br>${factor}: ${value}`);
                    circles.push(circle);
                });
                loading_info(false);
            },
            error: function () {
                loading_info(false);
                alert("資料載入失敗");
            }
        });
    }

    // 初始化滑桿
    function show_slider() {
        const handlesSlider = document.getElementById('slider');
        const step_value_start = document.getElementById('step_value_single');
        noUiSlider.create(handlesSlider, {
            start: 0,
            step: 1,
            connect: true,
            range: {
                'min': -12 * 11,
                'max': 0
            }
        });

        handlesSlider.noUiSlider.on('update', function (values) {
            step_value_start.innerHTML = minus_Month(values[0], "title");
            filename = minus_Month(values[0], "filename");
            load_data();
        });
    }

    $(document).ready(function () {
        show_slider();
    });
</script>

</body>
</html>
